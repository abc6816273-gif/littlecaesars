#!/usr/bin/env node

/**
 * Test the live API to verify coupon updates are working
 * Run with: node scripts/test-live-api.js
 */

async function testLiveAPI() {
  const liveUrl = 'https://texasroadhouse-menus.us';
  
  console.log('ğŸŒ Testing live API endpoints...\n');
  
  try {
    // Test GET endpoint
    console.log('ğŸ“¤ Testing GET /api/update-coupons...');
    const getResponse = await fetch(`${liveUrl}/api/update-coupons`, {
      method: 'GET',
      headers: {
        'User-Agent': 'live-api-test'
      }
    });
    
    console.log(`ğŸ“¥ GET Response: ${getResponse.status} ${getResponse.statusText}`);
    
    if (getResponse.ok) {
      const getData = await getResponse.json();
      console.log(`âœ… GET Success: ${getData.data?.coupons?.length || 0} coupons`);
      console.log(`ğŸ“Š Source: ${getData.data?.metadata?.source || 'Unknown'}`);
      console.log(`ğŸ• Last updated: ${getData.data?.lastUpdated || getData.data?.metadata?.last_updated || 'Unknown'}`);
    } else {
      const errorData = await getResponse.json();
      console.log(`âŒ GET Error: ${errorData.message || 'Unknown'}`);
    }
    
    console.log('\n' + '='.repeat(50) + '\n');
    
    // Test POST endpoint (force update)
    console.log('ğŸ“¤ Testing POST /api/update-coupons (force update)...');
    const postResponse = await fetch(`${liveUrl}/api/update-coupons`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'User-Agent': 'live-api-test-force'
      }
    });
    
    console.log(`ğŸ“¥ POST Response: ${postResponse.status} ${postResponse.statusText}`);
    
    if (postResponse.ok) {
      const postData = await postResponse.json();
      console.log(`âœ… POST Success: ${postData.data?.coupons?.length || 0} coupons generated`);
      console.log(`ğŸ¤– Generated by: ${postData.generatedBy || 'Unknown'}`);
      console.log(`ğŸ• Timestamp: ${postData.timestamp || 'Unknown'}`);
      console.log(`ğŸ”— Google Indexing: ${postData.googleIndexing ? 'Triggered' : 'Not triggered'}`);
      
      // Show sample coupons
      if (postData.data?.coupons?.length > 0) {
        console.log('\nğŸ« Sample coupons:');
        postData.data.coupons.slice(0, 2).forEach((coupon, index) => {
          console.log(`   ${index + 1}. ${coupon.code} - ${coupon.discount}`);
        });
      }
    } else {
      const errorData = await postResponse.json();
      console.log(`âŒ POST Error: ${errorData.message || 'Unknown'}`);
      console.log(`ğŸ” Details: ${errorData.error || 'No details'}`);
    }
    
    console.log('\nğŸ¯ Results Summary:');
    console.log(`   GET Endpoint: ${getResponse.ok ? 'âœ… Working' : 'âŒ Failed'}`);
    console.log(`   POST Endpoint: ${postResponse.ok ? 'âœ… Working' : 'âŒ Failed'}`);
    
    if (getResponse.ok && postResponse.ok) {
      console.log('\nğŸ‰ All endpoints are working! Your site should show real-time coupons.');
      console.log('ğŸ‘€ Visit your coupons page and look for "ğŸ¤– Live AI Data" badge.');
    } else {
      console.log('\nâš ï¸ Some endpoints failed. Check Vercel function logs for details.');
    }
    
  } catch (error) {
    console.error('\nâŒ Test failed:', error.message);
    
    if (error.message.includes('fetch')) {
      console.log('\nğŸ’¡ This might be a network issue or the site might be deploying.');
      console.log('   Try again in a few minutes.');
    }
  }
}

testLiveAPI().catch(console.error);
